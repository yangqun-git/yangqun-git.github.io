<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <link rel="shortcut icon" href="/images/avatar.png">
    

<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>

<meta charset="utf-8" >

<title>ArrayList iterator源码分析，为什么迭代器删除元素不会报错</title>
<meta name="keywords" content="ArrayList iterator源码分析，为什么迭代器删除元素不会报错, yangqunjava">
<meta name="description" content="ArrayList#grow扩容源码解析、ArrayList#iterator、迭代器删除元素">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" href="/style/main.css">


<link rel="stylesheet" href="/style/jquery.fancybox.min.css">


    <link rel="stylesheet" href="/style/gitalk.css" />






  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="https://www.yangqunjava.com">
        <img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px">
      </a>
      <a href="https://www.yangqunjava.com">
        <h1 class="site-title">yangqunjava</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        首页
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        归档
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        关于
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">ArrayList iterator源码分析，为什么迭代器删除元素不会报错</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2023-01-03</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/ArrayList/">
              ArrayList
                
                  ，
                
              </a>
            
              <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">
              源码分析
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <p>写这篇文章的原因要从前不久的一件事说起。</p>
<p>有一天，朋友问我，“ArrayList遍历中删除元素会怎么样”？</p>
<p>我当时脑子里第一想到的就是forEach这种循环方式，没多想就回答他：“当然会报错了。”</p>
<p>朋友再问：“如果使用iterator迭代器遍历删除呢？”</p>
<p>我：“那不会报错，可以正常删除。”</p>
<p>“为什么？”</p>
<p>为什么？我思索半刻，脑子里没有答案。</p>
<p>心想这种问题实在不该答不出来，只是自己在学习过程中确实没有关注过这些细节，只知道“会报错”或“不会报错”而已。</p>
<p>朋友见我不答，便又带几分引导的问：“forEach和iterator使用的是同一个remove方法吗？”</p>
<p>我又沉默，不久讪笑着说道：“不清楚。”</p>
</br>

<p>事后，我反思了自己的问题：在学习上不够仔细，只知其然而不知其所以然，虽也足以应对工作，但若是想在开发这条路上继续走下去，则是万万要改正的。</p>
<p>基于此教训，我也是开始关注这些“细枝末节”，并成文做记录，此就是其中一篇。</p>
</br>

<p>废话讲完，先看看下面的例子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// forEach方式</span></span><br><span class="line">ArrayList&lt;String&gt; l = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">l.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (String s : l) &#123;    <span class="comment">// ----- 结果：java.util.ConcurrentModificationException</span></span><br><span class="line">    l.remove(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 迭代器方式</span></span><br><span class="line">ArrayList&lt;String&gt; l = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">l.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">l.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">Iterator&lt;String&gt; iterator = l.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">next</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">    iterator.remove();   <span class="comment">// ----- 结果：正常删除</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如我对朋友所说，<code>forEach</code>会报错，<code>Iterator</code>能够如我们期望的删除掉元素。那它们两者有什么区别呢？朋友问我它们用的是不是同一个<code>remove</code>方法又是何意？</p>
<blockquote>
<p>forEach也不总是报错，会有巧合不报错的情况。</p>
</blockquote>
<h1 id="forEach语法"><a href="#forEach语法" class="headerlink" title="forEach语法"></a>forEach语法</h1><p>我们先来说一下<code>forEach</code>这个语法，java文档中叫它“The enhanced for statement”，翻译过来就是“增强for循环”。它是Java提供的一个语法糖，经过编译器的翻译后(javac命令)，它会被翻译成普通的for循环。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;String&gt; l = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">l.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (String s : l) &#123;</span><br><span class="line">    l.remove(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码在经过<code>javac</code>编译后的结果如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ArrayList&lt;String&gt; l = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">l.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> l.iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String)var2.next();</span><br><span class="line">    l.remove(s); <span class="comment">// ----- 用的是ArrayList的remove方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，原本<code>forEach</code>的部分被自动替换成了<code>Iterator</code>，方法里通过<code>Iterator#hasNext</code>来控制循环次数、通过<code>Iterator#next</code>方法来获取下一个元素。乍一看，好像和文章开头我们写的<code>Iterator</code>示例代码一样，但仔细看就会发现它的删除操作是使用了<code>ArrayList</code>本身的<code>remove</code>方法。</p>
<p>正是这个删除操作的不同，会导致我们在使用<code>forEach</code>删除元素时抛出<code>ConcurrentModificationException</code>异常，要搞清楚抛出异常的原因，我们需要先来看一下<code>ArrayList</code>的<code>remove</code>方法。</p>
<blockquote>
<p>使用增强for循环的表达式必须是Iterable接口的子类或是一个数组类型，否则会发生编译时错误。</p>
<p>至于数组类型的forEach会被翻译成什么样子，读者不妨自己亲自编译看下。</p>
</blockquote>
<h1 id="ArrayList-remove"><a href="#ArrayList-remove" class="headerlink" title="ArrayList#remove"></a>ArrayList#remove</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (elementData[index] == <span class="literal">null</span>) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; size; index++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(elementData[index])) &#123;</span><br><span class="line">                fastRemove(index);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fastRemove</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">int</span> <span class="variable">numMoved</span> <span class="operator">=</span> size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码很简单，就是遍历找到<strong>第一个相等的元素</strong>，然后把它从当前数组里剔除掉。元素的删除是由<code>System.arraycopy</code>方式完成的，删除之后维护一下<code>size</code>字段。</p>
<p>需要特别注意的是<code>modCount++</code>这个操作，该字段记录<code>list</code>在结构上被修改的次数。 结构修改是指那些改变<code>list</code>大小的修改，此字段由类<code>Iterator</code>和<code>ListIterator</code>使用，如果此字段的值意外更改，<code>Iterator</code>（或ListIterator）将抛出 <code>ConcurrentModificationException</code> 以响应 <code>next、remove、previous、set </code>或 <code>add</code> 操作。</p>
<p>如下贴出<code>Iterator</code>的<code>remove</code>方法，报错的原因就一目了然：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">Itr</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="type">int</span> cursor;       <span class="comment">// index of next element to return</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">lastRet</span> <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// index of last element returned; -1 if no such</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">expectedModCount</span> <span class="operator">=</span> modCount;</span><br><span class="line"></span><br><span class="line">    Itr() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cursor != size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> E <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (lastRet &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>();</span><br><span class="line">        checkForComodification();           <span class="comment">// ----- 看这里</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * final void checkForComodification() &#123;</span></span><br><span class="line"><span class="comment">         *     if (modCount != expectedModCount)</span></span><br><span class="line"><span class="comment">         *         throw new ConcurrentModificationException();</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ArrayList.<span class="built_in">this</span>.remove(lastRet);</span><br><span class="line">            cursor = lastRet;</span><br><span class="line">            lastRet = -<span class="number">1</span>;</span><br><span class="line">            expectedModCount = modCount;     <span class="comment">// ----- 看这里</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">forEachRemaining</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> E&gt; consumer)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">checkForComodification</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConcurrentModificationException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，文章结束，我们再回答文章一开始的问题，“forEach和iterator使用的是同一个remove方法吗”？答：是，只不过iterator里面包装了一些处理modCount字段的逻辑。</p>
<h1 id="参考目录"><a href="#参考目录" class="headerlink" title="参考目录"></a>参考目录</h1><p>1 ：</p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-14.html#jls-14.14.2">Java Language Specification</a></p>

        </div>
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#forEach%E8%AF%AD%E6%B3%95"><span class="top-box-text">forEach语法</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#ArrayList-remove"><span class="top-box-text">ArrayList#remove</span></a></li><li class="top-box-item top-box-level-1"><a class="top-box-link" href="#%E5%8F%82%E8%80%83%E7%9B%AE%E5%BD%95"><span class="top-box-text">参考目录</span></a></li></ol>
        </div>
      </div>
    </div>

    <!-- 
      <div class="next-post">
        <a class="purple-link" href="/2023/01/03/2023-01-03-ri-ji/">
          <h3 class="post-title">
            下一篇：2023-01-03日记
          </h3>
        </a>
      </div>
     -->
  </div>


  <div id="gitalk-container"></div>



<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a href="https://github.com/yangqun-git" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
    
     |
    
      <a class="icp" href="https://beian.miit.gov.cn" target="_blank">京ICP备2022034565号</a>
  
  
</div>
</footer>


      </div>
      
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.fancybox.min.js"></script>



    <script>window.is_post = true;</script>


<script src="/js/main.js"></script>



    <script src="/js/gitalk.min.js"></script>

<script>

  var gitalk = new Gitalk({
    clientID: 'e452846c760e4f6fd6a7',
    clientSecret: '9cd28d8b30dd90280f3adaa0fcd6ebc3309e97a3',
    repo: 'gitalk',
    owner: 'yangqun-git',
    admin: ['yangqun-git'],
    id: location.pathname.slice(1, location.pathname.lastIndexOf('/')).substring(0, 49),       // Ensure uniqueness and length less than 50
    distractionFreeMode: false,  // Facebook-like distraction free mode
    createIssueManually: true,
  });

  gitalk.render('gitalk-container')

</script>




    </div>
  </body>
</html>

